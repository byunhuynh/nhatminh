<!DOCTYPE html>
<html lang="vi" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>T·∫°o t√†i kho·∫£n</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' }</script>

  <!-- Toast -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <!-- Shared -->
  <script src="auth.js"></script>
  <script src="ui.js"></script>
  <script src="guard.js"></script>
  <script src="layout.js"></script>

  <style>
    .ui-dropdown { position: relative; }
    .ui-dropdown-panel {
      position: absolute;
      top: 100%; left: 0; right: 0;
      background: white;
      max-height: 220px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: .5rem;
      z-index: 50;
      display: none;
    }
    .ui-dropdown-panel.open { display: block; }
    .ui-dropdown-panel li {
      padding: .5rem .75rem;
      cursor: pointer;
    }
    .ui-dropdown-panel li:hover {
      background: #f3f4f6;
    }
    .dark .ui-dropdown-panel {
      background: #111827;
      border-color: #374151;
    }
    .dark .ui-dropdown-panel li:hover {
      background: #1f2937;
    }
  </style>
</head>

<body class="h-full bg-gradient-to-br from-slate-100 via-blue-100 to-indigo-200 dark:from-gray-900 dark:to-gray-800">
<div id="root" class="h-full"></div>

<script>
/* ================= CONFIG ================= */
const API_PROVINCE = "https://provinces.open-api.vn/api";
const ROLE_ORDER = ["sales", "supervisor", "director", "admin"];
let currentUser = null;

/* ================= Check Login ================= */
async function loadCurrentUser() {
  const res = await authFetch(API + "/me");
  if (!res) return;
  currentUser = await res.json();
}

/* ================= STATE ================= */
let selectedProvince = null;
let selectedDistrict = null;
let selectedWard = null;
let provinces = [], districts = [], wards = [];

/* ================= PAGE ================= */
document.addEventListener("DOMContentLoaded", async () => {
  if (!(await requireAdminPage())) return;
  updateThemeIcon();
  await loadCurrentUser();
  await loadLayout("users", `
    <div class="space-y-6 max-w-3xl mx-auto">

      <!-- ACCOUNT -->
      <div class="ui-card p-5">
        <h3 class="text-lg font-semibold mb-4">üîê Th√¥ng tin t√†i kho·∫£n</h3>
        <div class="grid sm:grid-cols-2 gap-4 text-sm">
          <div><label>Username *</label><input id="username" class="ui-input" placeholder="vd: nv_kinhdoanh01"></div>
          <div><label>M·∫≠t kh·∫©u *</label><input id="password" type="password" class="ui-input" placeholder="T·ªëi thi·ªÉu 6 k√Ω t·ª±"></div>

          <div>
            <label>Ch·ª©c v·ª•</label>
            <select id="role" class="ui-select">
              <option value="sales">Nh√¢n vi√™n kinh doanh</option>
              <option value="supervisor">Gi√°m s√°t kinh doanh</option>
              <option value="director">Gi√°m ƒë·ªëc kinh doanh</option>
              <option value="admin">Admin</option>
            </select>
          </div>

          <div>
            <label>C·∫•p tr√™n tr·ª±c ti·∫øp *</label>
            <select id="manager" class="ui-select">
              <option value="">-- Ch·ªçn ng∆∞·ªùi qu·∫£n l√Ω --</option>
            </select>
          </div>

          
        </div>
      </div>

      <!-- PERSONAL -->
      <div class="ui-card p-5">
        <h3 class="text-lg font-semibold mb-4">üë§ Th√¥ng tin c√° nh√¢n</h3>
        <div class="grid sm:grid-cols-2 gap-4 text-sm">
          <div><label>H·ªç t√™n</label><input id="full_name" class="ui-input"></div>
          <div><label>SƒêT</label><input id="phone" class="ui-input" placeholder="0xxxxxxxxx ho·∫∑c 84xxxxxxxxx"></div>
          <div class="sm:col-span-2"><label>Email</label><input id="email" class="ui-input" placeholder="abc@email.com"></div>
        </div>
      </div>

      <!-- ADDRESS -->
      <div class="ui-card p-5">
        <h3 class="text-lg font-semibold mb-4">üìç ƒê·ªãa ch·ªâ</h3>
        <div class="grid sm:grid-cols-2 gap-4 text-sm">

          <div class="ui-dropdown">
            <label>T·ªânh *</label>
            <input id="provinceInput" class="ui-input" placeholder="G√µ ƒë·ªÉ t√¨m">
            <ul id="provinceList" class="ui-dropdown-panel"></ul>
          </div>

          <div class="ui-dropdown">
            <label>Qu·∫≠n *</label>
            <input id="districtInput" class="ui-input" disabled>
            <ul id="districtList" class="ui-dropdown-panel"></ul>
          </div>

          <div class="ui-dropdown">
            <label>Ph∆∞·ªùng *</label>
            <input id="wardInput" class="ui-input" disabled>
            <ul id="wardList" class="ui-dropdown-panel"></ul>
          </div>

          <div>
            <label>S·ªë nh√†</label>
            <input id="street" class="ui-input" placeholder="VD: 123 L√™ L·ª£i">
          </div>
        </div>
      </div>

      <button onclick="createUser()" class="ui-btn ui-btn-primary w-full">
        ‚ûï T·∫°o t√†i kho·∫£n
      </button>
    </div>
  `);
  
  bindRealtimeValidation();

  filterCreatableRoles();
  role.onchange = loadManagersByRole;

  await loadManagersByRole();
  await loadProvinces();
  
});




function filterCreatableRoles() {
  const myIdx = ROLE_ORDER.indexOf(currentUser.role);

  [...role.options].forEach(opt => {
    const idx = ROLE_ORDER.indexOf(opt.value);
    opt.hidden = idx >= myIdx;
  });

  // auto ch·ªçn role th·∫•p nh·∫•t
  role.value = ROLE_ORDER[Math.max(0, myIdx - 1)];
}





/* ================= MANAGER ================= */
async function loadManagersByRole() {
  manager.innerHTML = "";

  // 1Ô∏è‚É£ Lu√¥n c√≥ "T√¥i"
  manager.innerHTML = `
    <option value="${currentUser.id}">
      ${currentUser.full_name || currentUser.username} (T√¥i)
    </option>
  `;

  manager.disabled = false;

  // 2Ô∏è‚É£ Admin
  if (currentUser.role === "admin") {
    const res = await authFetch(API + `/users/managers?role=${role.value}`);
    if (!res) return;

    const data = await res.json();

    data.forEach(u => {
      // ‚ùå b·ªè ch√≠nh m√¨nh ƒë·ªÉ kh√¥ng tr√πng "T√¥i"
      if (u.id === currentUser.id) return;

      manager.innerHTML += `
        <option value="${u.id}">
          ${u.full_name} (${u.role})
        </option>
      `;
    });
    return;
  }

  // 3Ô∏è‚É£ Director t·∫°o sales ‚Üí ch·ªçn supervisor thu·ªôc m√¨nh
  if (currentUser.role === "director" && role.value === "sales") {
    const res = await authFetch(API + `/users/subordinates?role=supervisor`);
    if (!res) return;

    const data = await res.json();
    data.forEach(u => {
      manager.innerHTML += `
        <option value="${u.id}">
          ${u.full_name} (Gi√°m s√°t)
        </option>
      `;
    });
  }
  

  // 4Ô∏è‚É£ Supervisor t·∫°o sales ‚Üí ch·ªâ c√≥ "T√¥i"
}



/* ================= ADDRESS ================= */
function render(list, ul, onPick) {
  ul.innerHTML = "";
  list.forEach(i => {
    const li = document.createElement("li");
    li.textContent = i.name;
    li.onclick = () => onPick(i);
    ul.appendChild(li);
  });
  ul.classList.add("open");
}

function filter(input, data, ul, pick) {
  render(data.filter(i =>
    i.name.toLowerCase().includes(input.value.toLowerCase())
  ), ul, pick);
}

async function loadProvinces() {
  apiLoadingStart();
  try {
    provinces = await (await fetch(`${API_PROVINCE}/p/`)).json();
    provinceInput.onfocus = () =>
      render(provinces, provinceList, pickProvince);
    provinceInput.oninput = () =>
      filter(provinceInput, provinces, provinceList, pickProvince);
  } finally {
    apiLoadingEnd();
  }
}

async function pickProvince(p) {
  selectedProvince = p;
  provinceInput.value = p.name;
  provinceList.classList.remove("open");

  districtInput.disabled = false;
  wardInput.disabled = true;
  districtInput.value = wardInput.value = "";

  apiLoadingStart();
  try {
    const data = await (await fetch(
      `${API_PROVINCE}/p/${p.code}?depth=2`
    )).json();

    districts = data.districts;
    districtInput.onfocus = () =>
      render(districts, districtList, pickDistrict);
    districtInput.oninput = () =>
      filter(districtInput, districts, districtList, pickDistrict);
  } finally {
    apiLoadingEnd();
  }
}


async function pickDistrict(d) {
  selectedDistrict = d;
  districtInput.value = d.name;
  districtList.classList.remove("open");

  wardInput.disabled = false;
  wardInput.value = "";

  const data = await (await fetch(`${API_PROVINCE}/d/${d.code}?depth=2`)).json();
  wards = data.wards;
  wardInput.onfocus = () => render(wards, wardList, pickWard);
  wardInput.oninput = () => filter(wardInput, wards, wardList, pickWard);
}

function pickWard(w) {
  selectedWard = w;
  wardInput.value = w.name;
  wardList.classList.remove("open");
}


function validateUserForm() {
  let ok = true;

  if (!rules.username(username.value.trim().toLowerCase())) {
    setError(username, "Username kh√¥ng h·ª£p l·ªá");
    ok = false;
  }

  if (!usernameAvailable) {
    setError(username, "Username ƒë√£ t·ªìn t·∫°i");
    ok = false;
  }

  if (!rules.password(password.value)) {
    setError(password, "M·∫≠t kh·∫©u t·ªëi thi·ªÉu 6 k√Ω t·ª±");
    ok = false;
  }

  if (!rules.phone(phone.value.replace(/\s+/g, ""))) {
    setError(phone, "S·ªë ƒëi·ªán tho·∫°i kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng");
    ok = false;
  }

  if (!rules.email(email.value)) {
    setError(email, "Email kh√¥ng h·ª£p l·ªá");
    ok = false;
  }

  if (!selectedProvince || !selectedDistrict || !selectedWard) {
    showToast("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß T·ªânh / Qu·∫≠n / Ph∆∞·ªùng", "error");
    ok = false;
  }

  return ok;
}



async function checkUsernameExists() {
  const v = username.value.trim().toLowerCase();
  if (!rules.username(v)) return;

  const res = await authFetch(API + `/users/check-username?username=${encodeURIComponent(v)}`);
  if (!res) return;

  const data = await res.json();

  if (data.exists) {
    usernameAvailable = false;
    setError(username, "Username ƒë√£ t·ªìn t·∫°i");
  } else {
    usernameAvailable = true;
    clearError(username);
  }
}



function setError(el, message) {
  el.classList.add("error");
  if (message) showToast(message, "error");
}

function clearError(el) {
  el.classList.remove("error");
}

/* ===== RULES ===== */
const rules = {
  username: v => /^[a-z0-9_]{4,30}$/.test(v),
  password: v => v.length >= 6,
  phone: v => !v || /^(0\d{9}|84\d{9})$/.test(v),
  email: v => !v || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v)
};

/* ===== REALTIME ===== */
function bindRealtimeValidation() {

  username.addEventListener("blur", checkUsernameExists);

  username.addEventListener("input", () => {
    const v = username.value.trim().toLowerCase();
    if (!rules.username(v)) setError(username);
    else clearError(username);
  });

  password.addEventListener("input", () => {
    if (!rules.password(password.value)) setError(password);
    else clearError(password);
  });

  phone.addEventListener("input", () => {
    const v = phone.value.replace(/\s+/g, "");
    if (!rules.phone(v)) setError(phone);
    else clearError(phone);
  });

  email.addEventListener("input", () => {
    if (!rules.email(email.value)) setError(email);
    else clearError(email);
  });

  role.addEventListener("change", () => {
    if (role.value !== "admin" && !manager.value)
      setError(manager);
    else
      clearError(manager);
  });

  manager.addEventListener("change", () => {
    if (manager.value) clearError(manager);
  });
}


function resetUserForm() {

  // text inputs
  username.value = "";
  password.value = "";
  full_name.value = "";
  phone.value = "";
  email.value = "";
  street.value = "";

  // select
  role.value = "sales";
  manager.innerHTML = `<option value="">-- Ch·ªçn ng∆∞·ªùi qu·∫£n l√Ω --</option>`;
  manager.disabled = false;
  usernameAvailable = true;

  // address inputs
  provinceInput.value = "";
  districtInput.value = "";
  wardInput.value = "";

  districtInput.disabled = true;
  wardInput.disabled = true;

  // clear selected state
  selectedProvince = null;
  selectedDistrict = null;
  selectedWard = null;

  // remove error styles
  document
    .querySelectorAll(".error")
    .forEach(el => el.classList.remove("error"));
}

/* ================= CREATE USER ================= */
async function createUser() {

  if (!validateUserForm()) return;

  const payload = {
    username: username.value.trim().toLowerCase(),
    password: password.value,
    full_name: full_name.value,
    phone: phone.value,
    email: email.value,
    role: role.value,
    manager_id: role.value === "admin" ? null : Number(manager.value),
    address: {
      province_code: selectedProvince.code,
      province_name: selectedProvince.name,
      district_code: selectedDistrict.code,
      district_name: selectedDistrict.name,
      ward_code: selectedWard.code,
      ward_name: selectedWard.name,
      street: street.value
    }
  };

  const res = await authFetch(API + "/users", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  if (!res || !res.ok)
    return showToast("T·∫°o t√†i kho·∫£n th·∫•t b·∫°i", "error");

  showToast("T·∫°o t√†i kho·∫£n th√†nh c√¥ng", "success");
  // reset form
  resetUserForm();
  // load l·∫°i manager list cho role m·∫∑c ƒë·ªãnh
  await loadManagersByRole();
  username.focus();
}

</script>
</body>
</html>
