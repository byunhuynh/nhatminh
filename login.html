<!doctype html>
<html lang="vi" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />

    <style>
      html,
      body {
        touch-action: manipulation;
      }

      input,
      button,
      select,
      textarea {
        font-size: 16px !important;
      }
    </style>

    <title>ƒêƒÉng nh·∫≠p</title>

    <link rel="stylesheet" href="assets/css/tailwind.min.css" />
    <link rel="stylesheet" href="assets/css/ui.css" />
    <link rel="stylesheet" href="assets/css/theme.anim.css" />
    <link rel="icon" href="assets/img/favicon.ico" />

    <link rel="stylesheet" href="assets/vendor/fontawesome/css/all.min.css" />

    <!-- Toast -->
    <link rel="stylesheet" href="assets/vendor/toastify/toastify.min.css" />
    <script src="assets/vendor/toastify/toastify.min.js"></script>
  </head>

  <body
    class="min-h-screen flex items-center justify-center bg-slate-100 dark:bg-slate-900 px-4"
  >
    <div class="relative flex items-center justify-center">
      <div
        class="pointer-events-none absolute w-[420px] h-[420px] rounded-full bg-[radial-gradient(circle_at_center,rgba(56,189,248,0.35),transparent_65%)] blur-3xl opacity-70 dark:bg-[radial-gradient(circle_at_center,rgba(56,189,248,0.45),transparent_65%)]"
      ></div>

      <div
        class="ui-card ui-login-card w-full max-w-[92vw] sm:max-w-sm md:max-w-md lg:max-w-sm p-6 relative z-10 transition-transform duration-200 hover:-translate-y-0.5 border border-sky-300 shadow-[0_0_0_1px_rgba(56,189,248,0.4),0_8px_24px_rgba(56,189,248,0.15)] hover:shadow-[0_0_0_1px_rgba(56,189,248,0.6),0_12px_36px_rgba(56,189,248,0.25)] dark:border-sky-500 dark:shadow-[0_0_0_1px_rgba(56,189,248,0.6),0_8px_32px_rgba(56,189,248,0.25)] dark:hover:shadow-[0_0_0_1px_rgba(56,189,248,0.8),0_12px_48px_rgba(56,189,248,0.35)]"
      >
        <!-- Dark mode toggle -->
        <button
          id="themeToggle"
          onclick="toggleDarkMode()"
          class="theme-toggle theme-toggle--login absolute top-4 right-4"
          aria-label="ƒê·ªïi giao di·ªán"
        >
          <i class="fa-solid fa-moon"></i>
        </button>

        <div class="flex flex-col items-center mb-6 gap-1">
          <img src="assets/img/logo.png" class="h-20 mb-4" alt="Nh·∫≠t Minh" />
          <p class="text-sm text-gray-500 dark:text-gray-400">
            S·∫°ch ‚Äì Th∆°m ‚Äì An to√†n
          </p>
        </div>

        <!-- USERNAME -->
        <form id="loginForm" autocomplete="on">
          <!-- USERNAME -->
          <div class="mb-4">
            <label for="username" class="text-sm mb-1 block"> T√†i kho·∫£n </label>
            <div class="ui-input-icon">
              <i class="fa-solid fa-id-card"></i>
              <input
                id="username"
                name="username"
                class="ui-input"
                autocomplete="username"
                placeholder="Nh·∫≠p t√†i kho·∫£n c·ªßa b·∫°n"
                required
              />
            </div>
          </div>

          <!-- PASSWORD -->
          <div class="mb-4">
            <label for="password" class="text-sm mb-1 block"> M·∫≠t kh·∫©u </label>
            <div class="ui-input-icon ui-input-password">
              <i class="fa-solid fa-lock"></i>
              <input
                id="password"
                name="password"
                type="password"
                class="ui-input"
                autocomplete="current-password"
                placeholder="Nh·∫≠p m·∫≠t kh·∫©u c·ªßa b·∫°n"
                required
              />
              <button
                type="button"
                class="ui-password-toggle"
                aria-label="Hi·ªán m·∫≠t kh·∫©u"
                onclick="togglePassword('password', this)"
              >
                <i class="fa-regular fa-eye"></i>
              </button>
            </div>
          </div>

          <!-- REMEMBER LOGIN -->
          <div
            id="rememberToggle"
            onclick="toggleRemember()"
            class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400 cursor-pointer select-none mb-4"
          >
            <i
              id="rememberIcon"
              class="fa-solid fa-toggle-on text-sky-500 text-xl"
            ></i>
            <span>Ghi nh·ªõ ƒëƒÉng nh·∫≠p</span>
          </div>

          <button
            id="loginBtn"
            type="submit"
            class="w-full ui-btn ui-btn-primary"
          >
            <i class="fa-solid fa-arrow-right-to-bracket fa-beat"></i>
            <span>ƒêƒÉng nh·∫≠p</span>
          </button>
        </form>

        <p class="text-xs text-center text-gray-400 mt-6">¬© 2026 Nh·∫≠t Minh</p>
        <div
          id="loginOverlay"
          class="absolute inset-0 hidden bg-white/60 dark:bg-slate-900/60 backdrop-blur-sm items-center justify-center rounded-xl"
        >
          <div class="flex items-center gap-2 text-sky-500 font-medium">
            <i class="fa-solid fa-spinner fa-spin"></i>
            <span>ƒêang ƒëƒÉng nh·∫≠p...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= CORE (ƒê√öNG PATH) ================= -->

    <script src="core/config.js"></script>
    <script src="core/storage.js"></script>
    <script src="ui/theme.js"></script>
    <script src="ui/theme.anim.js"></script>
    <script src="ui/toast.js"></script>

    <!-- ================= LOGIN LOGIC ================= -->
    <script>
      const btn = document.getElementById("loginBtn");

      async function handleLogin() {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value;
        const remember = rememberMe;

        if (!username || !password) {
          showToast("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin", "error");
          return;
        }

        btn.disabled = true;
        btn.innerHTML = `
  <i class="fa-solid fa-spinner fa-spin"></i>
  <span>ƒêang ƒëƒÉng nh·∫≠p...</span>
`;

        try {
          const res = await fetch(API + "/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });

          if (!res.ok) {
            showToast("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u", "error");
            return;
          }

          const data = await res.json();

          if (remember) {
            // üîê remember login (mobile)
            storage.set("access_token", data.access_token);
            storage.set("refresh_token", data.refresh_token);
            storage.set("remember_login", "1");
          } else {
            // ‚è≥ session only
            sessionStorage.setItem("access_token", data.access_token);
            storage.remove("refresh_token");
            storage.remove("remember_login");
          }

          localStorage.setItem("login_notice", "1");

          location.replace("./#/");
        } finally {
          btn.disabled = false;
          btn.innerHTML = `
  <i class="fa-solid fa-arrow-right-to-bracket fa-beat"></i>
  <span>ƒêƒÉng nh·∫≠p</span>
`;
        }
      }

      btn.addEventListener("click", handleLogin);

      // ===============================
      // Show logout notice
      // ===============================
      if (localStorage.getItem("logout_notice")) {
        localStorage.removeItem("logout_notice");
        showToast("ƒê√£ ƒëƒÉng xu·∫•t", "warning");
      }
    </script>

    <script>
      // ==================================
      // Toggle password with auto-hide (2s)
      // ==================================
      const __pwTimers = new WeakMap();

      function togglePassword(inputId, btn) {
        const input = document.getElementById(inputId);
        if (!input || !btn) return;

        const icon = btn.querySelector("i");
        if (!icon) return;

        // clear timer c≈© n·∫øu c√≥
        if (__pwTimers.has(input)) {
          clearTimeout(__pwTimers.get(input));
          __pwTimers.delete(input);
        }

        const isHidden = input.type === "password";

        // toggle
        input.type = isHidden ? "text" : "password";

        icon.classList.toggle("fa-eye", !isHidden);
        icon.classList.toggle("fa-eye-slash", isHidden);

        btn.setAttribute(
          "aria-label",
          isHidden ? "·∫®n m·∫≠t kh·∫©u" : "Hi·ªán m·∫≠t kh·∫©u",
        );

        // n·∫øu v·ª´a hi·ªán ‚Üí auto hide sau 2s
        if (isHidden) {
          const timer = setTimeout(() => {
            input.type = "password";

            icon.classList.remove("fa-eye-slash");
            icon.classList.add("fa-eye");

            btn.setAttribute("aria-label", "Hi·ªán m·∫≠t kh·∫©u");
            __pwTimers.delete(input);
          }, 2000);

          __pwTimers.set(input, timer);
        }
      }
      let rememberMe = true;

      function toggleRemember() {
        rememberMe = !rememberMe;

        const icon = document.getElementById("rememberIcon");
        const wrap = document.getElementById("rememberToggle");

        if (!icon || !wrap) return;

        icon.classList.toggle("fa-toggle-off", !rememberMe);
        icon.classList.toggle("fa-toggle-on", rememberMe);
        wrap.classList.toggle("active", rememberMe);
      }

      // ===============================
      // Restore remember login toggle
      // ===============================
      // ===============================
      // Restore remember login (default ON)
      // ===============================
      if (storage.get("remember_login") === null) {
        // l·∫ßn ƒë·∫ßu / ch∆∞a t·ª´ng t·∫Øt ‚Üí gi·ªØ ON
        rememberMe = true;
      } else {
        // ƒë√£ c√≥ remember_login ‚Üí ƒë·ªçc ƒë√∫ng tr·∫°ng th√°i
        rememberMe = storage.get("remember_login") === "1";
      }

      const icon = document.getElementById("rememberIcon");
      const wrap = document.getElementById("rememberToggle");

      if (rememberMe) {
        icon?.classList.add("fa-toggle-on");
        icon?.classList.remove("fa-toggle-off");
        wrap?.classList.add("active");
      } else {
        icon?.classList.add("fa-toggle-off");
        icon?.classList.remove("fa-toggle-on");
        wrap?.classList.remove("active");
      }
    </script>
  </body>
</html>
